<!-- Search file for "CHANGE" for my own changes -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>dev_guide API documentation</title>
<meta name="description" content="Developer guide â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<link rel="preconnect" href="https://www.google.com">
<script async src="https://cse.google.com/cse.js?cx=017837193012385208679:pey8ky8gdqw"></script>
<style>
.gsc-control-cse {padding:0 !important;margin-top:1em}
body.gsc-overflow-hidden #sidebar {overflow: visible;}
</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
<a href="https://github.com/patricknraanes/mpl-tools" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>dev_guide</code></h1>
</header>
<section id="section-intro">
<p>Developer guide.</p>
<h2 id="why-use-make-publish-instead-of-just-poetry-publish">Why use <code>make publish</code> instead of just <code>poetry publish</code>?</h2>
<p>As opposed to <code>poetry publish</code>, this accomplishes</p>
<ul>
<li>Builds docs.</li>
<li>Bumps version with <code>poetry</code>, and tags <code>git</code> with the result,
thus synchronizing these versions
(note that <code>__init__.py</code> gets its <code>__version__</code> independently).
<code>Travis</code> then gets triggered, and since the commit includes a tag,
it will deploy to <code>PyPI.</code> Of course, Travis is slow,
but it means that only successfully tested builds are published.</li>
</ul>
<h2 id="want-tests-to-run-on-any-level-pytest-tox-travis">Want tests to run on any level (<code>pytest</code>, <code>tox</code>, <code>travis</code>)</h2>
<p>Note that Travis ain't really a level above tox
(although it's true that with travis you can even test on different
OS and platform versions), as explained under <code>Why not tox?</code>.</p>
<h2 id="why-a-makefile-when-you-already-use-poetrypyprojecttoml">Why a makefile (when you already use <code>poetry/pyproject.toml</code>) ?</h2>
<p>Poetry not only deals with dependency resolution.
It also handles packaging/distribution. But, only for PyPI (<code>pip</code>).</p>
<p>So how are "applications" (vs "libraries") to be packaged?
Using pipx? Distributing as .deb package? What about MacOS? etc.
<a href="https://docs.python-guide.org/shipping/freezing/#freezing-your-code-ref">Ref</a>
Remember, they need to create an isolated python environment,
and download (or vendorize) dependencies.</p>
<p>Similarly, how should it be installed from source (github),
for the purpose of development?
One alternative is to state that poetry is prerequisite.
Another way is to provide this makefile, since (GNU) make
is pretty (awful, but) universal. This makefile takes care of
the poetry installation, together with the venv activation,
package and pre-commit installation (with poetry).</p>
<p>The makefile is also useful as a task runner (invoker),
avoiding the necessity for multiple small scripts
for testing, cleaning, linting.
Some of the tasks are simple enough that it might be better
just to read the recipe and do them yourself.
Indeed this makefile hardly takes advantage of the main pros
of <code>make</code> (DAG of dependencies combined with mtime;
support for incremental and parallel builds).
Nevertheless, the makefile still serves as a reminder of
which tasks "exist", as shown by running <code>make</code> without arguments.
Note that task execution could
<a href="https://github.com/python-poetry/poetry-core/pull/40">maybe</a>
be handled by poetry in the future.</p>
<h4 id="is-the-makefile-using-the-best-way-to-get-poetry">Is the makefile using the best way to get poetry?</h4>
<p>It's using the "official" way. Whether it's the best,
for our purposes, I don't know. Other alternatives:
- See also a more secure and detailed version at
<a href="https://github.com/wrike/callisto/blob/master/Makefile">https://github.com/wrike/callisto/blob/master/Makefile</a>
- Could also use <code>pip install poetry</code>, but that's not really recommended.
- Pipx is probably not a good idea either, ref:
<a href="https://github.com/python-poetry/poetry/issues/677#issuecomment-443372910">https://github.com/python-poetry/poetry/issues/677#issuecomment-443372910</a>
- Approaches using venv:
<a href="https://news.ycombinator.com/item?id=20677114">https://news.ycombinator.com/item?id=20677114</a>
<a href="https://stackoverflow.com/a/59335943/38281">https://stackoverflow.com/a/59335943/38281</a></p>
<h3 id="items">Items</h3>
<p>Screw cookiecutter and pyscaffold. Use this skeleton
coc-settings
Poetry/pyproject</p>
<p>Linting</p>
<ul>
<li>Editor: useful</li>
<li>Precommit: useful. Maybe not markdownlint though?</li>
<li>Travis: for PRs</li>
<li>As part of pytest - maybe for heavier (eg pylint) linting.</li>
<li>As part of tox - nah. This is one overlap too many</li>
</ul>
<p>Why doesn't makefile use <code>pre-commit</code>
(e.g. <code>@$(POETRY) run pre-commit flakehell -a</code>) for linting?
Vice-versa, why does travis use pre-commit for linting?
Pre-commit's flakehell plugin deps are manually kept in sync
(pre-commit will likely never support pyproject.toml)
with pyproject.toml. So they might get out-of-sync,
which is a slight disadvantage.
Other than that, there's not really any good reason.
I just had to chose something.</p>
<p>Flakehell
Unlike flake8, flakehell
- may be configured in pyproject.toml
- has prettier formatting
- does not use installed plugins that are not listed below
One interesting option not explored yet is to
inherit from remote config (or local if you want), e.g.:
<code>base = "https://raw.githubusercontent.com/life4/flakehell/master/pyproject.toml"</code></p>
<p>Flakehell also enables intricate plugin configuration.
Examples follow.
NB: remember to comment-out the corresponding lines above</p>
<pre><code>pyflakes = ["+*", "-F401"] # ignore F401
pycodestyle = ["+*", "-E722"] # ignore E722
flake8-docstrings = ["-*"] # explicitly disable plugin
flake8-bandit = ["+*", "-S322"]
flake8-bandit = ["-*", "+S1??"] # enable only codes from S100 to S199

# Exceptions:
# [tool.flakehell.exceptions."tests/"]
# pycodestyle = ["-F401"]     # disable a check
# pyflakes = ["-*"]           # disable a plugin
# [tool.flakehell.exceptions."tests/test_example.py"]
# pyflakes = ["+*"]           # enable a plugin
</code></pre>
<p>Installation and tasks with Makefile</p>
<p>Pytest
- Using mpl image comparison</p>
<p>Tox requires that the python versions exist on your system.
=&gt; pyenv</p>
<p>Travis-CI</p>
<pre><code># AFAIK, the main reason to use tox on travis-ci (as well as locally)
# is just to avoid repeating ourselves.
</code></pre>
<p>Deploy when git tag is pushed</p>
<h2 id="toxpoetry">Tox/poetry</h2>
<p>Poetry/tox integration is subject to rapid change, ref:
- <a href="https://tox.readthedocs.io/en/latest/example/package.html#poetry">https://tox.readthedocs.io/en/latest/example/package.html#poetry</a>
- <a href="https://tox.readthedocs.io/en/latest/example/basic.html#pyproject-toml-tox-legacy-ini">https://tox.readthedocs.io/en/latest/example/basic.html#pyproject-toml-tox-legacy-ini</a>
- <a href="https://python-poetry.org/docs/faq/#is-tox-supported">https://python-poetry.org/docs/faq/#is-tox-supported</a>
- <a href="https://github.com/python-poetry/poetry/issues/1941">https://github.com/python-poetry/poetry/issues/1941</a>
- <a href="https://github.com/python-poetry/poetry/issues/1745">https://github.com/python-poetry/poetry/issues/1745</a></p>
<p>Remember,
- <code>envlist</code> lists the tests run by default.
Use CLI option <code>-e</code> to only run particular ones.
Tests can be detailed using [testenv:myname] sections.
- <code>toxworkdir={homedir}/.tox</code> puts the tox envs in HOME,
to avoid Dropbox syncing them.
- <code>isolated_build = True</code> is required with poetry
- <code>install_dev_deps</code> comes with <code>tox-poetry-installer</code> and is used to install the
- dev-dependencies already specified in pyproject.toml
(avoids repeating ourselves)
- from the lockfile (for reproducibility)</p>
<h2 id="toxcoverage">Tox/Coverage</h2>
<p>Tox installs in its own venv, while <code>coverage</code> is pointed to the repo
(from its config in pyproject.toml).
Therefore there will be <code>0%</code> coverage.
Refs:</p>
<ul>
<li><a href="https://stackoverflow.com/a/59072005/38281">1</a></li>
<li><a href="https://pytest-cov.readthedocs.io/en/latest/tox.html">2</a>.</li>
</ul>
<p>It is possible to get coverage reports ALSO from within tox runs,
but it requires that pytest be configured via tox,
which is a bit uglier, requiring that you set
<code>tool.tox.legacy_tox_ini</code> to the following:</p>
<pre><code>```ini
[tox]
envlist = clean,py3{8,9}
isolated_build = True

[testenv]
install_dev_deps = true

# Pytest explanations
# * envsitepackagesdir : &lt;https://stackoverflow.com/a/59072005&gt;
# * cov-append         : &lt;https://pytest-cov.readthedocs.io/en/latest/tox.html&gt;
# * term-missing       : List lines not covered
# * {posargs}          : arguments forwarded from tox command
commands =
    pytest         --cov {envsitepackagesdir}/mpl_tools         --cov-append         --cov-report=term-missing         {posargs}

[testenv:clean]
install_dev_deps = false
deps = coverage
skip_install = true
commands = coverage erase
```
</code></pre>
<h2 id="travis-ci">Travis-CI</h2>
<h4 id="why-pip3">Why pip3 ?</h4>
<p><a href="https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems">Ref</a></p>
<pre><code>all three OSes agree about 'pip3'
'python' points to Python 2.7 on macOS but points to Python 3.8 on Linux and Windows
'python3' is a 'command not found' error on Windows but 'py' works on Windows only
</code></pre>
<h4 id="why-only-1-python-version-of-macos">Why only 1 python version of MacOS?</h4>
<p>Coz that's pretty much all Travis supports.
<a href="https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems">Ref</a></p>
<ul>
<li>Potentially another
<a href="https://docs.travis-ci.com/user/multi-os/#python-example-unsupported-languages">way</a></li>
<li>Potentially another
<a href="https://github.com/travis-ci/travis-ci/issues/9929#issuecomment-505232416">way</a></li>
</ul>
<h4 id="why-stages">Why stages?</h4>
<p>Jobs run in parallel. But some things should only run
after others have succeeded (eg. "deploy")
=&gt; <a href="https://docs.travis-ci.com/user/build-stages/#what-are-build-stages">Stages</a>
The top-level <code>stages</code> key just serves to specify their order.</p>
<h4 id="can-the-deploy-stage-be-moved-outside-of-jobsinclude">Can the deploy stage be moved outside of <code>jobs.include</code></h4>
<p>Yes, it can be moved to the top level, as seen in many travis doc examples.
You can then remove the <code>stage</code> and the <code>script</code> keys.
You might need some checks (something similar to
<code>condition: $TRAVIS_BUILD_STAGE_NAME = Deploy</code>) to ensure
it won't deploy for each job.</p>
<h4 id="why-not-makefile">Why not makefile?</h4>
<p>It would probably be possible to replace some of the instructions
in <code>.travis.yml</code> with <code>make blah</code>,
but there are also quite a few differences,
so we don't bother to try with that.
Also, the makefile is supposed to be for linux only,
while Travis can test other platforms.</p>
<h4 id="why-not-tox">Why not tox?</h4>
<p>Checkout <code>3a7750</code> for a working Travis/Tox version.
AFAICT, the primary benefit of running tox on travis
(including the use of the <code>tox-travis</code> package to
only use the python version currently configured by Travis)
is that it reads your <code>tox</code> configuration. This
<a href="https://github.com/python-poetry/poetry/issues/366#issuecomment-634666677">example</a>
seems case-in-point.
However, I have configured pytest in <code>[tool.pytest.ini_options]</code>,
i.e. outside of <code>[tool.tox]</code>
So I might as well just run <code>pytest</code> directly.</p>
<h4 id="why-not-poetry-publish-merely-poetry-build">Why not <code>poetry publish</code> (merely <code>poetry build</code>)?</h4>
<p>Because then we can use
<a href="https://docs.travis-ci.com/user/deployment/pypi/">Travis' encryption mechanism</a>
to store my encrypted pypi-global API token in <code>.travis.yml</code>
instead of relying on Github or Travis secrets
(which requires manual configuration for each new project).
Now, the build log does complain
<code>python: can't open file
'/home/travis/build/patricknraanes/mpl-tools/setup.py':
[Errno 2] No such file or directory</code>
but nevertheless proceeds with the upload (built by poetry).
Checkout <code>75ba468</code> for the previous ("secrets") version.</p>
<h2 id="starting-a-new-project">Starting a new project</h2>
<ul>
<li>Copy this one</li>
<li>Go through pyproject.toml and change it as needed</li>
<li>Rm this dev_guide.py, and (all of) the html files</li>
<li><code>grep</code> <code>mpl-tools</code>, <code><a title="mpl_tools" href="mpl_tools/index.html">mpl_tools</a></code>, <code>patricknraanes,</code> and change as appropriate</li>
<li>Turn on Travis and Coveralls through their web interface</li>
<li><code>make publish</code></li>
</ul>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/patricknraanes/mpl-tools/blob/master/docs/dev_guide.py#L0-L263" class="git-link">Browse git</a>
</summary>
<pre><code class="python">&#34;&#34;&#34;Developer guide.

## Why use `make publish` instead of just `poetry publish`?
As opposed to `poetry publish`, this accomplishes

- Builds docs.
- Bumps version with `poetry`, and tags `git` with the result,
  thus synchronizing these versions
  (note that `__init__.py` gets its `__version__` independently).
  `Travis` then gets triggered, and since the commit includes a tag,
  it will deploy to `PyPI.` Of course, Travis is slow,
  but it means that only successfully tested builds are published.

## Want tests to run on any level (`pytest`, `tox`, `travis`)
Note that Travis ain&#39;t really a level above tox
(although it&#39;s true that with travis you can even test on different
OS and platform versions), as explained under `Why not tox?`.

## Why a makefile (when you already use `poetry/pyproject.toml`) ?
Poetry not only deals with dependency resolution.
It also handles packaging/distribution. But, only for PyPI (`pip`).

So how are &#34;applications&#34; (vs &#34;libraries&#34;) to be packaged?
Using pipx? Distributing as .deb package? What about MacOS? etc.
[Ref](https://docs.python-guide.org/shipping/freezing/#freezing-your-code-ref)
Remember, they need to create an isolated python environment,
and download (or vendorize) dependencies.

Similarly, how should it be installed from source (github),
for the purpose of development?
One alternative is to state that poetry is prerequisite.
Another way is to provide this makefile, since (GNU) make
is pretty (awful, but) universal. This makefile takes care of
the poetry installation, together with the venv activation,
package and pre-commit installation (with poetry).

The makefile is also useful as a task runner (invoker),
avoiding the necessity for multiple small scripts
for testing, cleaning, linting.
Some of the tasks are simple enough that it might be better
just to read the recipe and do them yourself.
Indeed this makefile hardly takes advantage of the main pros
of `make` (DAG of dependencies combined with mtime;
support for incremental and parallel builds).
Nevertheless, the makefile still serves as a reminder of
which tasks &#34;exist&#34;, as shown by running `make` without arguments.
Note that task execution could
[maybe](https://github.com/python-poetry/poetry-core/pull/40)
be handled by poetry in the future.

#### Is the makefile using the best way to get poetry?
It&#39;s using the &#34;official&#34; way. Whether it&#39;s the best,
for our purposes, I don&#39;t know. Other alternatives:
- See also a more secure and detailed version at
  https://github.com/wrike/callisto/blob/master/Makefile
- Could also use `pip install poetry`, but that&#39;s not really recommended.
- Pipx is probably not a good idea either, ref:
  https://github.com/python-poetry/poetry/issues/677#issuecomment-443372910
- Approaches using venv:
  https://news.ycombinator.com/item?id=20677114
  https://stackoverflow.com/a/59335943/38281


### Items
Screw cookiecutter and pyscaffold. Use this skeleton
coc-settings
Poetry/pyproject

Linting

- Editor: useful
- Precommit: useful. Maybe not markdownlint though?
- Travis: for PRs
- As part of pytest - maybe for heavier (eg pylint) linting.
- As part of tox - nah. This is one overlap too many

Why doesn&#39;t makefile use `pre-commit`
(e.g. `@$(POETRY) run pre-commit flakehell -a`) for linting?
Vice-versa, why does travis use pre-commit for linting?
Pre-commit&#39;s flakehell plugin deps are manually kept in sync
(pre-commit will likely never support pyproject.toml)
with pyproject.toml. So they might get out-of-sync,
which is a slight disadvantage.
Other than that, there&#39;s not really any good reason.
I just had to chose something.

Flakehell
Unlike flake8, flakehell
- may be configured in pyproject.toml
- has prettier formatting
- does not use installed plugins that are not listed below
One interesting option not explored yet is to
inherit from remote config (or local if you want), e.g.:
`base = &#34;https://raw.githubusercontent.com/life4/flakehell/master/pyproject.toml&#34;`

Flakehell also enables intricate plugin configuration.
Examples follow.
NB: remember to comment-out the corresponding lines above

    pyflakes = [&#34;+*&#34;, &#34;-F401&#34;] # ignore F401
    pycodestyle = [&#34;+*&#34;, &#34;-E722&#34;] # ignore E722
    flake8-docstrings = [&#34;-*&#34;] # explicitly disable plugin
    flake8-bandit = [&#34;+*&#34;, &#34;-S322&#34;]
    flake8-bandit = [&#34;-*&#34;, &#34;+S1??&#34;] # enable only codes from S100 to S199

    # Exceptions:
    # [tool.flakehell.exceptions.&#34;tests/&#34;]
    # pycodestyle = [&#34;-F401&#34;]     # disable a check
    # pyflakes = [&#34;-*&#34;]           # disable a plugin
    # [tool.flakehell.exceptions.&#34;tests/test_example.py&#34;]
    # pyflakes = [&#34;+*&#34;]           # enable a plugin

Installation and tasks with Makefile

Pytest
- Using mpl image comparison

Tox requires that the python versions exist on your system.
=&gt; pyenv

Travis-CI

    # AFAIK, the main reason to use tox on travis-ci (as well as locally)
    # is just to avoid repeating ourselves.


Deploy when git tag is pushed

## Tox/poetry

Poetry/tox integration is subject to rapid change, ref:
- &lt;https://tox.readthedocs.io/en/latest/example/package.html#poetry&gt;
- &lt;https://tox.readthedocs.io/en/latest/example/basic.html\
#pyproject-toml-tox-legacy-ini&gt;
- &lt;https://python-poetry.org/docs/faq/#is-tox-supported&gt;
- &lt;https://github.com/python-poetry/poetry/issues/1941&gt;
- &lt;https://github.com/python-poetry/poetry/issues/1745&gt;

Remember,
- `envlist` lists the tests run by default.
  Use CLI option `-e` to only run particular ones.
  Tests can be detailed using [testenv:myname] sections.
- `toxworkdir={homedir}/.tox` puts the tox envs in HOME,
  to avoid Dropbox syncing them.
- `isolated_build = True` is required with poetry
- `install_dev_deps` comes with `tox-poetry-installer` and is used to install the
  - dev-dependencies already specified in pyproject.toml
    (avoids repeating ourselves)
  - from the lockfile (for reproducibility)

## Tox/Coverage
Tox installs in its own venv, while `coverage` is pointed to the repo
(from its config in pyproject.toml).
Therefore there will be `0%` coverage.
Refs:

- [1](https://stackoverflow.com/a/59072005/38281)
- [2](https://pytest-cov.readthedocs.io/en/latest/tox.html).

It is possible to get coverage reports ALSO from within tox runs,
but it requires that pytest be configured via tox,
which is a bit uglier, requiring that you set
`tool.tox.legacy_tox_ini` to the following:

    ```ini
    [tox]
    envlist = clean,py3{8,9}
    isolated_build = True

    [testenv]
    install_dev_deps = true

    # Pytest explanations
    # * envsitepackagesdir : https://stackoverflow.com/a/59072005
    # * cov-append         : https://pytest-cov.readthedocs.io/en/latest/tox.html
    # * term-missing       : List lines not covered
    # * {posargs}          : arguments forwarded from tox command
    commands =
        pytest \
        --cov {envsitepackagesdir}/mpl_tools \
        --cov-append \
        --cov-report=term-missing \
        {posargs}

    [testenv:clean]
    install_dev_deps = false
    deps = coverage
    skip_install = true
    commands = coverage erase
    ```

## Travis-CI

#### Why pip3 ?
[Ref](https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems)

    all three OSes agree about &#39;pip3&#39;
    &#39;python&#39; points to Python 2.7 on macOS but points to Python 3.8 on Linux and Windows
    &#39;python3&#39; is a &#39;command not found&#39; error on Windows but &#39;py&#39; works on Windows only

#### Why only 1 python version of MacOS?
Coz that&#39;s pretty much all Travis supports.
[Ref](https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems)

- Potentially another
  [way](https://docs.travis-ci.com/user/multi-os/#python-example-unsupported-languages)
- Potentially another
  [way](https://github.com/travis-ci/travis-ci/issues/9929#issuecomment-505232416)

#### Why stages?
Jobs run in parallel. But some things should only run
after others have succeeded (eg. &#34;deploy&#34;)
=&gt; [Stages](https://docs.travis-ci.com/user/build-stages/#what-are-build-stages)
The top-level `stages` key just serves to specify their order.

#### Can the deploy stage be moved outside of `jobs.include`
Yes, it can be moved to the top level, as seen in many travis doc examples.
You can then remove the `stage` and the `script` keys.
You might need some checks (something similar to
`condition: $TRAVIS_BUILD_STAGE_NAME = Deploy`) to ensure
it won&#39;t deploy for each job.

#### Why not makefile?
It would probably be possible to replace some of the instructions
in `.travis.yml` with `make blah`,
but there are also quite a few differences,
so we don&#39;t bother to try with that.
Also, the makefile is supposed to be for linux only,
while Travis can test other platforms.

#### Why not tox?
Checkout `3a7750` for a working Travis/Tox version.
AFAICT, the primary benefit of running tox on travis
(including the use of the `tox-travis` package to
only use the python version currently configured by Travis)
is that it reads your `tox` configuration. This
[example](https://github.com/python-poetry/poetry/issues/366#issuecomment-634666677)
seems case-in-point.
However, I have configured pytest in `[tool.pytest.ini_options]`,
i.e. outside of `[tool.tox]`
So I might as well just run `pytest` directly.

#### Why not `poetry publish` (merely `poetry build`)?
Because then we can use
[Travis&#39; encryption mechanism](https://docs.travis-ci.com/user/deployment/pypi/)
to store my encrypted pypi-global API token in `.travis.yml`
instead of relying on Github or Travis secrets
(which requires manual configuration for each new project).
Now, the build log does complain
`python: can&#39;t open file
&#39;/home/travis/build/patricknraanes/mpl-tools/setup.py&#39;:
[Errno 2] No such file or directory`
but nevertheless proceeds with the upload (built by poetry).
Checkout `75ba468` for the previous (&#34;secrets&#34;) version.

## Starting a new project

- Copy this one
- Go through pyproject.toml and change it as needed
- Rm this dev_guide.py, and (all of) the html files
- `grep` `mpl-tools`, `mpl_tools`, `patricknraanes,` and change as appropriate
- Turn on Travis and Coveralls through their web interface
- `make publish`
&#34;&#34;&#34;</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="gcse-search" style="height: 70px"
data-as_oq="inurl:github.com/patricknraanes/mpl-tools site:mpl-tools.github.io"
data-gaCategoryParameter="dev_guide">
</div>
<h1>Index</h1>
<div class="toc">
<ul>
<li><a href="#why-use-make-publish-instead-of-just-poetry-publish">Why use make publish instead of just poetry publish?</a></li>
<li><a href="#want-tests-to-run-on-any-level-pytest-tox-travis">Want tests to run on any level (pytest, tox, travis)</a></li>
<li><a href="#why-a-makefile-when-you-already-use-poetrypyprojecttoml">Why a makefile (when you already use poetry/pyproject.toml) ?</a><ul>
<li><a href="#is-the-makefile-using-the-best-way-to-get-poetry">Is the makefile using the best way to get poetry?</a></li>
<li><a href="#items">Items</a></li>
</ul>
</li>
<li><a href="#toxpoetry">Tox/poetry</a></li>
<li><a href="#toxcoverage">Tox/Coverage</a></li>
<li><a href="#travis-ci">Travis-CI</a><ul>
<li><a href="#why-pip3">Why pip3 ?</a></li>
<li><a href="#why-only-1-python-version-of-macos">Why only 1 python version of MacOS?</a></li>
<li><a href="#why-stages">Why stages?</a></li>
<li><a href="#can-the-deploy-stage-be-moved-outside-of-jobsinclude">Can the deploy stage be moved outside of jobs.include</a></li>
<li><a href="#why-not-makefile">Why not makefile?</a></li>
<li><a href="#why-not-tox">Why not tox?</a></li>
<li><a href="#why-not-poetry-publish-merely-poetry-build">Why not poetry publish (merely poetry build)?</a></li>
</ul>
</li>
<li><a href="#starting-a-new-project">Starting a new project</a></li>
</ul>
</div>
<ul id="index">
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>